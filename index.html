<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Subic Ibaba Eco Action</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
* { box-sizing: border-box; }

body {
    margin: 0;
    font-family: "Trebuchet MS", Arial, sans-serif;
    background: #eef5ea;
}

/* HEADER */
header {
    background: linear-gradient(180deg, #6fbf73, #4c9a58);
    color: white;
    text-align: center;
    padding: 25px;
    font-size: 36px;
    font-weight: bold;
    border-bottom: 6px solid #3d7f46;
}

/* DASHBOARD GRID */
#dashboard {
    display: grid;
    grid-template-columns: 3fr 2fr;
    gap: 20px;
    padding: 20px;
}

/* PLANNING BOARD */
#planning {
    display: flex;
    gap: 15px;
    grid-column: 1 / span 2;
}

.quarter {
    background: #fffdf4;
    border-radius: 12px;
    padding: 12px;
    width: 100%;
    border: 3px solid #d9c9a3;
    box-shadow: 0 6px 0 #cbb98b;
}

.quarter h3 {
    text-align: center;
    background: #8b5a2b;
    color: white;
    padding: 6px;
    border-radius: 6px;
    font-size: 14px;
    margin-bottom: 10px;
}

/* NOTES */
.note {
    height: 60px;
    border-radius: 6px;
    margin-bottom: 10px;
    box-shadow: 2px 3px 0 rgba(0,0,0,0.2);
}
.yellow { background: #f3d45c; }
.green { background: #7fcf8a; }
.blue { background: #9ed0f6; }

.note[contenteditable="true"] {
    border: 2px dashed #c0392b;
    cursor: text;
}

/* TABLE */
table {
    width: 100%;
    border-collapse: collapse;
    background: #fffdf4;
    border-radius: 12px;
    overflow: hidden;
    border: 3px solid #d9c9a3;
}

th {
    background: #4c9a58;
    color: white;
    padding: 10px;
}

td {
    border: 1px solid #d9c9a3;
    padding: 5px;
}

td button {
    background: #c0392b;
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 6px;
    cursor: pointer;
}

#rightPanel {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

#map {
    height: 250px;
    border-radius: 12px;
    border: 4px solid #6fa76f;
}

#updates {
    display: flex;
    gap: 10px;
}

#updates .label {
    background: #f3d45c;
    padding: 12px;
    font-weight: bold;
    border-radius: 8px;
}

#updates .content {
    background: #fffdf4;
    flex: 1;
    border-radius: 8px;
    padding: 12px;
    border: 2px solid #d9c9a3;
}

#updates .content[contenteditable="true"] {
    border: 2px dashed #c0392b;
}

#form {
    background: #fffdf4;
    padding: 15px;
    border-radius: 12px;
    border: 3px solid #d9c9a3;
}

button.submit {
    background: #4c9a58;
    color: white;
    font-weight: bold;
    padding: 10px;
    border-radius: 6px;
}
</style>
</head>

<body>

<header>Subic Ibaba Eco Action</header>

<div id="dashboard">

<div id="planning">
    <div class="quarter"><h3>JANâ€“MAR</h3><div class="note yellow"></div><div class="note blue"></div><div class="note green"></div></div>
    <div class="quarter"><h3>APRâ€“JUNE</h3><div class="note green"></div><div class="note yellow"></div><div class="note blue"></div></div>
    <div class="quarter"><h3>JULYâ€“SEPT</h3><div class="note blue"></div><div class="note green"></div><div class="note yellow"></div></div>
    <div class="quarter"><h3>OCTâ€“DEC</h3><div class="note green"></div><div class="note yellow"></div><div class="note blue"></div></div>
</div>

<div style="grid-column:1 / span 2;">
<table id="volunteerTable">
<tr><th>Name</th><th>Contact</th><th>Availability</th><th>Action</th></tr>
</table>
</div>

<div id="rightPanel">
    <div id="map"></div>

    <div id="updates">
        <div class="label">GENERAL UPDATES</div>
        <div class="content">Loading...</div>
    </div>

    <div id="form">
        <h3>Volunteer Sign-Up</h3>
        <form id="signupForm">
            <input id="name" placeholder="Name" required>
            <input id="contact" placeholder="Contact" required>
            <textarea id="availability" placeholder="Availability" required></textarea>
            <button class="submit">Add Volunteer</button>
        </form>
    </div>
</div>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getFirestore, 
  collection, 
  addDoc, 
  deleteDoc, 
  onSnapshot, 
  doc, 
  setDoc,
  enableIndexedDbPersistence
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDOIEqttkf43bV61HLpbDDYt7yr92I13Zg",
  authDomain: "ecoactionibaba.firebaseapp.com",
  projectId: "ecoactionibaba",
  storageBucket: "ecoactionibaba.firebasestorage.app",
  messagingSenderId: "367012227040",
  appId: "1:367012227040:web:3b7c517cba2b6ee4c0ad85"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ðŸ”¥ OFFLINE + RELOAD PERSISTENCE FIX */
enableIndexedDbPersistence(db).catch(e => console.warn(e.code));

const table = document.getElementById("volunteerTable");
const form = document.getElementById("signupForm");
const notes = document.querySelectorAll(".note");
const updatesContent = document.querySelector("#updates .content");

/* MAP */
const map = L.map('map').setView([13.9360, 120.9250], 15);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

/* VOLUNTEERS */
onSnapshot(collection(db, "volunteers"), snapshot => {
  table.innerHTML = `
    <tr><th>Name</th><th>Contact</th><th>Availability</th><th>Action</th></tr>`;

  snapshot.forEach(d => addRow(d));
});

form.addEventListener("submit", async e => {
  e.preventDefault();
  await addDoc(collection(db, "volunteers"), {
    name: name.value,
    contact: contact.value,
    availability: availability.value,
    created: Date.now()
  });
  form.reset();
});

function addRow(docSnap) {
  const v = docSnap.data();
  const r = table.insertRow();
  r.insertCell().innerText = v.name;
  r.insertCell().innerText = v.contact;
  r.insertCell().innerText = v.availability;

  const c = r.insertCell();
  const b = document.createElement("button");
  b.innerText = "Delete";
  b.onclick = () => deleteDoc(doc(db, "volunteers", docSnap.id));
  c.appendChild(b);
}

/* SCHEDULE */
notes.forEach((note, idx) => {
  note.setAttribute("contenteditable","true");
  note.addEventListener("blur", async () => {
    await setDoc(doc(db,"schedule",`note${idx}`),{ content: note.innerText });
  });
});

onSnapshot(collection(db,"schedule"), snap => {
  snap.forEach(d => {
    const i = parseInt(d.id.replace("note",""));
    if(notes[i]) notes[i].innerText = d.data().content;
  });
});

/* UPDATES */
updatesContent.setAttribute("contenteditable","true");

updatesContent.addEventListener("blur", async () => {
  await setDoc(doc(db,"generalUpdates","agoncillo"),{ content: updatesContent.innerText });
});

onSnapshot(doc(db,"generalUpdates","agoncillo"), d => {
  if(d.exists()) updatesContent.innerText = d.data().content;
});
</script>

</body>
</html>
